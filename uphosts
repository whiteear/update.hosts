#!/usr/bin/env bash
#
# free to copy and distribute this repo and all source files.
# author: cyliu7@gmail.com
#

THIS=`realpath $0`
HROOT=`dirname $THIS`
[ ! -d "$HROOT" ] && echo "ERROR: $HROOT is not dir" && exit -1;

export HROOT

cd $HROOT
# if need to update gfwhosts, then update it firstly.
if [ -x up-gfwhosts ];then
    ./up-gfwhosts
fi

# generate new hosts file
TMPF=`mktemp`
cat > $TMPF <<EOF
#################################################################
#
# auto generated by uphosts program. DO NOT EDIT IT MANUALLY.
#

EOF

echo "# updated on: `date`" >> $TMPF
echo >> $TMPF

if [ -d "$HROOT/hosts.d" ];then
    cd $HROOT/hosts.d/
    ls -1 *.hosts | while read hfile;do
        echo "##########################" >> $TMPF
        echo "# FROM: $hfile " >> $TMPF
        cat $hfile >> $TMPF
        echo >> $TMPF
    done
fi

# let's update the hosts files
cp -f $TMPF /etc/hosts
echo 'update done'
